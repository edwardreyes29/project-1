<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        #tooltip {
            visibility: hidden;
            height: auto;
            width: auto;
        }
    </style>
</head>
<body>
    <h2 id="title">US Coronavirus statistics in the United States</h2>
    <div id="description">Number of confirmed cases per state</div>
    <div id="tooltip"></div>
    <svg id="my_dataviz" width="1000px" height="600"></svg>
    <svg id='legend'>
        <g>
            <rect x="10" y="0" width="40" height="40" fill="#fadbd8"></rect>
            <text x="60" y="20" fill="black">&lt;= 1,000 cases</text>
        </g>
        <g>
            <rect x="10" y="40" width="40" height="40" fill="#f1948a"></rect>
            <text x="60" y="60" fill="black">&lt;= 10,000 cases</text>
        </g>
        <g>
            <rect x="10" y="80" width="40" height="40" fill="#e74c3c"></rect>
            <text x="60" y="100" fill="black">&lt;= 100,000 cases</text>
        </g>
        <g>
            <rect x="10" y="120" width="40" height="40" fill="#b03a2e"></rect>
            <text x="60" y="140" fill="black">&lt;= 1,000,000 cases</text>
        </g>
    </svg>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
        integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.1/js/bootstrap.min.js"
        integrity="sha384-XEerZL0cuoUbHE4nZReLT7nx9gQrQreJekYhJD9WNWhH8nEW+0c5qq7aIo2Wl30J"
        crossorigin="anonymous"></script>
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"
        integrity="sha512-4UKI/XKm3xrvJ6pZS5oTRvIQGIzZFoXR71rRBb1y2N+PbwAsKa5tPl2J6WvbEvwN3TxQCm8hMzsl/pO+82iRlg=="
        crossorigin="anonymous"></script>
    <script>
        // {fips: 1011, state: "AL", area_name: "Bullock County", bachelorsOrHigher: 14.1}
        // get county name, fips, state, and confirmed
        var countyApi = {
            "async": true,
            "crossDomain": true,
            "url": "https://coronavirus-us-api.p.rapidapi.com/api/state/all?source=nyt",
            "method": "GET",
            "headers": {
                "x-rapidapi-host": "coronavirus-us-api.p.rapidapi.com",
                "x-rapidapi-key": "73403c6c67msha0632541172766bp194ccejsn820ec377a86a"
            }
        }

        // $.ajax(countyApi).done(function (response) {
        //     console.log(response);


        // });

        
        $.getJSON("https://coronavirus-us-api.p.rapidapi.com/api/state/all?source=nyt&rapidapi-key=73403c6c67msha0632541172766bp194ccejsn820ec377a86a", function (data) {
            var fillColor; // to hold fill color for hover
            // console.log(data);
            let covidData = data.locations;
            jsonData = []
            // {fips: 1011, state: "AL", area_name: "Bullock County", bachelorsOrHigher: 14.1}
            let educationURL = 'https://cdn.freecodecamp.org/testable-projects-fcc/data/choropleth_map/for_user_education.json';
            let educationData
            let tooltip = d3.select('#tooltip')

            // The svg
            var svg = d3.select("svg"),
                width = +svg.attr("width"),
                height = +svg.attr("height");

            // Map and projection
            var projection = d3.geoMercator()
                .center([0, 20])                // GPS of location to zoom on
                .scale(99)                       // This is like the zoom
                .translate([width / 2, height / 2])

            d3.queue()
                .defer(d3.json, "https://cdn.freecodecamp.org/testable-projects-fcc/data/choropleth_map/counties.json")  // World shape
                .defer(d3.json, educationURL)
                .await(ready);

            function ready(error, data, eduData) {
                console.log(data)
                // console.log(eduData)
                console.log(covidData)

                dataGeo = topojson.feature(data, data.objects.states).features;
    
                // Draw the world map
                svg.append("g")
                    .selectAll("path")
                    .data(dataGeo)
                    .enter()
                    .append("path")
                    .style("stroke", "white")
                    .attr('d', d3.geoPath()) // method that converts geometry into string given to svg 
                    .attr('class', 'county')
                    // Add a fill color based on the number of covid cases
                    .attr('fill', (dataGeoItem) => {
                        let id = dataGeoItem.id // get state id

                        let state = covidData.find((item) => { // like a for loop, searches each item to see if it matches id
                            return item['fips'] === id;
                        })
                        
                        let confirmed = state.latest.confirmed;
                        // return color based on number of cases
                        if (confirmed <= 1000) {
                            return '#fadbd8'
                        } else if (confirmed <= 10000) {
                            return ' #f1948a '
                        } else if (confirmed <= 100000) {
                            return '#e74c3c'
                        } else {
                            return '#b03a2e'
                        }
                    })
                    .attr('data-fips', (dataGeoItem) => {
                        return dataGeoItem.id
                    })
                    .attr('data-cases', (dataGeoItem) => { // set attribute to number of cases per state
                        let id = dataGeoItem.id // get state id
                        let state = covidData.find((item) => {
                            return item['fips'] === id;
                        })
                        let cases = state.latest.confirmed;
                        return cases;
                    })
                    .attr('data-state', (dataGeoItem) => { // set attribute to the state
                        let id = dataGeoItem.id // get state id
                        let state = covidData.find((item) => {
                            return item['fips'] === id;
                        })
                        let foundState = state['state'];
                        return foundState;
                    })
                    .on('mouseover', (dataGeoItem) => {
                        fillColor = d3.event.target.attributes[2].nodeValue;
                        d3.event.target.attributes[2].nodeValue = '#f4d03f'
                        tooltip.transition()
                            .style('visibility', 'visible')
                        let id = dataGeoItem.id; // get county id
                        let state = covidData.find((item) => {
                            return item['fips'] === id;
                        })
                        tooltip.text(state['fips'] + ' - ' + state['state'] + ' : ' + state.latest.confirmed)
                    })
                    .on('mouseout', (countyDataItem) => {
                        d3.event.target.attributes[2].nodeValue = fillColor;
                        tooltip.transition()
                            .style('visbility', 'visible');
                    })
            }

        });
    </script>
</body>

</html>